---
title: "ERA-Explore"
author: "Peter Steward"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ERA-Explore}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r packages,include=F,eval=T,echo=T}
require(ERAg)
require(treemap)
```

## Exploring the data
In this vignette we will cover how to visualise data in the ERA dataset.

### Unsplitting combined pracitces
Observations in the main `ERA.Compiled` often consist of bundles of practices which may relate to more than one product. 

```{r Combo numbers, echo =TRUE}
# No. combination practices
nrow(ERA.Compiled[grepl("-",SubPrName)])

# No. solo practices
nrow(ERA.Compiled[!grepl("-",SubPrName)])
```


This makes visualization of
the dataset difficult as there are over a 1000 subpractice combinations creating too many values to map onto a figure. We can use the `ERAComboSplit` 
function to "split" these practice and product combinations into duplicate individual rows each contain a unique combination of any practice x product
combination present in the original observation.  

```{r Splitting Combinations, echo =T}

# There are many subpractice combinations in ERA
ERA.Compiled[grepl("-",SubPrName),length(unique(SubPrName))]
ERA.Compiled[,unique(SubPrName)][1:10]

# Lets split these
ERA.Compiled.Split<-ERAComboSplit(Data=ERA.Compiled)

# The dataset gets longer
dim(ERA.Compiled)
dim(ERA.Compiled.Split)

# Suffixed .Combo columns contain split names and codes
grep(".Combo",colnames(ERA.Compiled.Split),value=T)
# Combine codes have gone in the .Combo columns
ERA.Compiled.Split[grepl("-",SubPrName.Combo),length(unique(SubPrName.Combo))]
# Only single values are presnt
ERA.Compiled.Split[,unique(SubPrName.Combo)][1:10]


```
### Treemaps
We can use the "split" dataset to explore how many instance of products, practices or outcomes there are. Treemaps are great way of visualizing these data using the `treemap::treemap()` function.

```{r Treemap, echo =T,fig.width=7,fig.asp=0.66}

# First we count the number of studies per level of the practice heirarchy (see PracticeCodes object for more information on the practice heirarchy)
ERA.Compiled.Split.Pracs<-ERA.Compiled.Split[,list(N.Studies=length(unique(Code))),by=list(SubPrName.Combo,PrName.Combo,Theme.Combo)]

head(ERA.Compiled.Split.Pracs)

# Visualize with the treemap function
treemap::treemap(ERA.Compiled.Split.Pracs,
      index=c("Theme.Combo","PrName.Combo"),
      vSize="N.Studies",
      type="index",
      palette = "Paired",
      title="Number of Studies reporting ERA practices")
```
