---
title: "ERA-Climate-Data"
author: "Peter Steward"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ERA-Climate-Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette will explore how to download and extract climate information for point locations with buffers of spatial uncertainty.

## Section 1: Downloading and extracting climate data for ERA locations

### Load required packages
```{r load packages, eval=F,echo=T}
  if(!require("pacman", character.only = TRUE)){
    install.packages("pacman",dependencies = T)
  }
  
  required.packages <- c("data.table","doSNOW","ERAg","miceadds","ncdf4","raster","rgeos","sp","terra")
  p_load(char=required.packages,install = T,character.only = T)
    
```
### Subset the data
First we will subset the ERA.Compiled dataset to exclude locations with a large radius of spatial uncertainty (in this case >50km). It is difficult to define climate for locations with high levels of spatial uncertainty and their large areas increase the download and processing requirements for download and analysis of climate data.

```{r Subset ERA,echo=T,eval=F}
ERA.Data<-ERA.Compiled[Buffer<50000]
```

### Set a date of temporal origin
When analyzing climate data it is convenient that each date has a unique and sequential number that indicates the number of days from a temporal point of origin. The point of origin is arbitrary, but should be before the date of the first observation in a dataset. 

```{r set M.Origin,echo=T,eval=F}
M.ORIGIN<-"1900-01-01"
```

### AgMERRA
The `ExtractAgMERRA` function extracts daily climate data from AgMERRA .nc4 files. With larger datasets the function can take some hours to run and caution is advised when using parallelization (see `cores` argument) as memory requirements are high.

Before running the function you will need to download all AgMERRA files from [this repository](https://data.giss.nasa.gov/impacts/agmipcf/agmerra/) to a local directory, then specify this directory as the `AgMERRA_dir` argument in the function call.  In the example below the AgMerra .nc4 files have downloaded to a folder called `AgMERRA Downloads` in the working directory.  

The extracted dataset is returned and saved as an `AgMERRA.RData` object in the directory specified by the `Save_Dir` argument (in the example below this is the `AgMERRA` folder in the working directory.  

```{r AgMERRA,echo = T, eval = F}

AgMERRA<-ExtractAgMERRA(DATA=ERA.Data,
              ID="Site.Key",
              AgMERRA_dir = "/AgMERRA Downloads",
              TempDir = "/Temp",
              Save_Dir = "/AgMERRA",
              cores=4,
              Years = c(1980,2010),
              M.ORIGIN = M.ORIGIN)
```

*AgMERRA is the AgMIP climate forcing dataset based on the NASA Modern-Era Retrospective Analysis for Research and Applications (MERRA). AgMERRA
corrects to gridded temperature and precipitation, incorporates satellite precipitation, and derives solar radiation from NASA/GEWEX SRB to cover
the 1980-2010 period. AgMERRA is somewhat dated, but our primary use for it is to gap fill missing solar radiation values in POWER values.*

### CHIRPS
There are three phases to extraction of CHIRPS precipitation data: 1) downloading the data using the `DownloadCHIRPS` function; 2) reformatting the data using the `ReformatCHIRPS` function; and 3) extracting the data using the `ExtractCHIRPS` function.  

#### 1) Download
This function download the CHIRPS 2.0 dataset as .tif.gz files with 0.05 degree resolution from an online [repository](https://data.chc.ucsb.edu/products/CHIRPS-2.0/africa_daily/tifs/p05/1981/) to the local directory specified in the `SaveDir` argument.

```{r download CHIRPS,echo=T,eval=FALSE}
DownloadCHIRPs(StartYear=1983,
               EndYear=2019,
               SaveDir=paste0(getwd(),"/CHIRPS Downloads"))
```

#### 2) Reformat
The `ReformatCHIRPS` function transforms the CHIRPS data downloaded by the `DownloadCHIRPS` function to be an array object from which data can be quickly extracted. The directory containing the download CHIRPS data is specified by `CHIRPS_dir` argument.  

```{r reformat CHIRPS,echo=T,eval=FALSE}
ReformatCHIRPS<-function(CHIRPS_dir=paste0(getwd(),"/CHIRPS Downloads"),
                         Save_dir=paste0(getwd(),"/CHIRPS Reformatted")
```
#### 3) Extract
The `ExtractCHIRPS` function extracts daily climate data from a reformatted CHIRPS object created by the `ReformatCHIRPS` and located in the directory specified by the `CHIRPS_dir` argument.  The period for which data are extracted for, specified by the `YStart` and `YEnd` arguments, should not exceed the bounds of the years specified when the CHIRPS data were downloaded.  

```{r extract CHIRPS,echo=T,eval=FALSE}
CHIRPS<-ExtractCHIRPS(DATA = ERA.Data,
                     ID = "Site.Key",
                     CHIRPS_dir="/CHIRPS Reformatted",
                     Save_Dir = "/CHIRPS",
                     YStart = 1983,
                     YEnd = 2019,
                     ROUND=5,
                     M.ORIGIN=M.ORIGIN)
```

### POWER
The `ExtractPOWER` function downloads agroclimatology data at 0.05&deg resolution from the [NASA POWER](https://power.larc.nasa.gov/) dataset using an AP query. As it is an API query the download process is slow and may take many hours.

The code below will download chunks of data for combination of POWER parameter (specified in the `Parameters` argument) and `Site.Key` for the period 1983-07-01 to 2018-12-31. The parameters chosen allow the calculation of Penman-Montieth evapotranspiration.  

Downloaded files are stored in the directory specified by the `Save_Dir` argument and once all the data have been downloaded they are combined together and saved as a `POWER.RData` object in the directory specified in the `PowerSave` argument. The `DELETE` argument removes downloaded files when set to `TRUE`.


```{r POWER,echo = T, eval = F}
POWER<-ExtractPOWER(DATA=ERA.Data,
                   Parameters= paste0("ALLSKY_SFC_SW_DWN,", "PRECTOT,", "PS,","QV2M,","RH2M,","T2M,","T2M_MAX,","T2M_MIN,","WS2M"),
                   StartDate=19830701,
                   EndDate=20181231,
                   ID="Site.Key",
                   Save_Dir="/POWERdownloads",
                   PowerSave="/POWER",
                   DELETE=FALSE,
                   M.ORIGIN=M.ORIGIN,
                   MaxBuffer=50000) 

```

*NASA POWER Solar parameters are derived from NASA's GEWEX/SRB release 3.0 archive (July 1, 1983 – Dec. 31, 2007) and NASA’s CERES FLASHFlux project (Jan. 1, 2008 – to within about 7-days of real time). Meteorological parameters are derived from the NASA's GMAO MERRA-2 assimilation model (Jan. 1, 1981 to within a few months of real time) plus GEOS-5.12.4 FP-IT (End of MERRA-2 to within several days of real time). The data in POWER cover the period 1983-07-01 to near present.*

### *Pending: BioClim*

### Calculating reference PET (potential evapotranspiration)
Agroclimatology datasets such as POWER contain the variables needed to calculate reference PET, but before we can do this we need to add altitude and gap fill some missing solar radiation values.  

#### Add altitude
Altitude data can be added from the `ERA_Physical` object of the `ERAg` package.

```{r add altitude, echo=T,eval=F}

    funX<-function(ID){
      ID.NAME<-ID
      ERA_Physical[match(ID.NAME,unlist(ERA_Physical[,Site.Key])),Altitude.mean]
    }
    
    POWER[,Altitude:=funX(Site.Key[1]),by=Site.Key]
    rm(funX)
    
```

#### Subsitute missing solar radiation values

First we see if missing POWER solar radiation (`SRad`) values can be substituted from the AgMERRA dataset that covers 1980-2010.  

We add a field `SRad.Sub` to indicate rows with substituted values and the source of substituted data.  

```{r sub SRad AgMERRA, echo=T,eval=F}
      N<-POWER[,which(is.na(SRad))]
      M<-match(paste(unlist(POWER[N,..ID]),POWER[N,DayCount]),paste(unlist(AgMERRA[,..ID]),AgMERRA[,DayCount]))
      NN<-which(!is.na(M))
      POWER[N[NN],SRad:=AgMERRA[M[NN],Solar.Rad]]
      POWER[N[NN],SRad.Sub:="AgMERRA"]
      rm(N,NN)
```

For remaining values we use the `ReplaceSRAD` function to search withing the POWER dataset for temporally adjacent `SRad` values. The solar radiation value of the day with the most similar rainfall to the NA value within +/- a number of days specified by the `SeqLen` argument is substituted. Rainfall data is complete in POWER. So if `SeqLen = 3` then the function assesses rainfall similarity 3 days either side of a missing SRad value and chooses the most similar value with a corresponding SRad value.  

```{r sub SRad nearby, echo=T,eval=F}
      N<-POWER[,which(SRad<0|is.na(SRad))]
      if(length(N)>0){
      R<-ReplaceSRAD(SRad = POWER[,SRad],Rain = POWER[,Rain],N,SeqLen=3)
      POWER[N,SRad:=R]
      POWER[N,SRad.Sub:="Nearby"]
      rm(N,R)
      
```

#### Calculate PET
The `PETcalc` function applies the  [FAO Penman-Monteith method](http://www.fao.org/docrep/X0490E/x0490e06.htm) to  calculate reference evapotranspiration. 

```{r Add PET, echo =T, eval=F}
    POWER[,ETo:=PETcalc(Tmin=Temp.Min,
                      Tmax=Temp.Max,
                      SRad=SRad,
                      Wind=WindSpeed,
                      Rain=Rain,
                      Pressure=Pressure,
                      Humid=Humid,
                      YearDay=Day,
                      Latitude=Latitude,
                      Altitude=Altitude)$ETo]
```

#### Calculate annual and long-term climate stats
Complete data for a year is require to calculate annual climate statistics, so first we remove any incomplete years (years with missing data)

```{r remove missing years, echo =T, eval=F}
      POWER<-POWER[!Year==POWER[Site.Key==POWER$Site.Key[1],list(N=.N),by=Year][N<365,Year]]
```

Next we calculate annual statistics using the `data.table` `by =` syntax to apply functions by groups, in this case the groups are the `Site.Key` and `Year`. In this example we use the POWER dataset but the approach can be applied to other daily climate datasets.

```{r calculate annual, echo =T, eval=F}
      POWER.Annual<-POWER[,list(Total.Rain=sum(Rain),
                                Total.ETo=sum(ETo),
                                S.Humid.Mean=mean(Specific.Humid),
                                Humid.Mean=mean(Humid),
                                Temp.Mean.Mean=mean(Temp.Mean),
                                Mean.N.30.Days=sum(Temp.Mean>30),
                                Temp.Max.Mean=mean(Temp.Max),
                                Temp.Max=max(Temp.Max),
                                Max.N.40.Days=sum(Temp.Max>40),
                                Temp.Min.Mean=mean(Temp.Min),
                                Temp.Min=min(Temp.Min)),by=c("Site.Key","Year")]
```

Now we use the annual climate statistics to calculate long-term averages from the  calculated above, this time the only grouping variable will use is `Year`.

```{r calculate LTA, echo =T, eval=F}
      POWER.LT<-POWER.Annual[,list(Total.Rain.Mean=mean(Total.Rain),
                                   Total.ETo.Mean=mean(Total.ETo),
                                   S.Humid.Mean=mean(S.Humid.Mean),
                                   Humid.Mean=mean(Humid.Mean),
                                   Temp.Mean.Mean=mean(Temp.Mean.Mean),
                                   Mean.N.30.Days=mean(Mean.N.30.Days),
                                   Temp.Max.Mean=mean(Temp.Max.Mean),
                                   Temp.Max=mean(Temp.Max),
                                   Max.N.40.Days=mean(Max.N.40.Days),
                                   Temp.Min.Mean=mean(Temp.Min.Mean),
                                   Temp.Min.Mean=mean(Temp.Min),
                                   Total.Rain.sd=sd(Total.Rain),
                                   Total.ETo.sd=mean(Total.ETo),
                                   S.Humid.Mean.sd=sd(S.Humid.Mean),
                                   Humid.Mean.sd=sd(Humid.Mean),
                                   Temp.Mean.Mean.sd=sd(Temp.Mean.Mean),
                                   Mean.N.30.Days.sd=sd(Mean.N.30.Days),
                                   Temp.Max.Mean.sd=sd(Temp.Max.Mean),
                                   Temp.Max.sd=sd(Temp.Max),
                                   Max.N.40.Days.sd=sd(Max.N.40.Days),
                                   Temp.Min.Mean.sd=sd(Temp.Min.Mean),
                                   Temp.Min.sd=sd(Temp.Min)
      ),by=c("Site.Key")]
```

To explore annual deviance from long-term averages subtract the long-term average from the annual values.

## Section 2: Calculating statistics from the extracted climate data

Once we have extracted the climate data we can estimate long-term, annual and seasonal climate variables for each buffered point location. We will be calculating variables such as reference evapotranspiration, rainfall, growing degree days and dry spells.    

The `ERAg` functions used in this section of the vignette are less generalisable to non-ERA datasets and require specific fields in the dataset to define growing seasons including fields describing Planting and Harvest dates.

### Load required packages
```{r CS load packages, eval=F,echo=T}
  if(!require("pacman", character.only = TRUE)){
    install.packages("pacman",dependencies = T)
  }
  
  required.packages <- c("ggplot2","circular","data.table","doSNOW","zoo","pbapply","ERAg","dismo","miceadds")
  p_load(char=required.packages,install = T,character.only = T)
```

### Prepare analytical environment
#### Create save directories
```{r CS create dirs, eval=F,echo=T}
# Create a directory for the climate analysis
AnalysisDir<-"ERA Climate Analysis/"
if(!dir.exists(AnalysisDir)){
  dir.create(AnalysisDir)
}

# Create a directory for strange or incorrect ERA values to investigate
ErrorDir<-paste0(AnalysisDir,"Potential Errors/")
if(!dir.exists(ErrorDir)){
  dir.create(ErrorDir)
}
  
# Create a directory for crop specific information
CROP_dir<-paste0(AnalysisDir,"Crops/") 
if(!dir.exists(CROP_dir)){
  dir.create(CROP_dir)
}

```

#### Load datasets
Access the ERA.Compiled dataset from the `ERAg` package.
```{r CS read in ERA, eval=F,echo=T}
ERA<-ERAg::ERA.Compiled
```

We will also require extracted climate data for our sites, this can be created using the methods outline in Section 1 of this vignette or, more conveniently, prepared data can be downloaded from the `ERAg` github using the piggyback methods outline in the `ERA-Large-Climate-Files` vignette.

```{r CS download large file, echo=TRUE,eval=F}
Sys.setenv(GITHUB_TOKEN = "ghp_XXXXXXXXXXXXXXXXXXXXXXXX")

LargeDir<-"Large Files/"

  if(!dir.exists(LargeDir)){
    dir.create(LargeDir,recursive = T)
  }
  
  for(FILE in c("POWER.RData","AgMERRA.RData")){
    piggyback::pb_download(file= FILE, 
                repo = "peetmate/ERAg",
                tag = "Beta_v0.0.1",
                dest = LargeDir)
  }
  
  POWER<-data.table(miceadds::load.Rdata2("POWER.RData",path=LargeDir))
  CHIRPS<-data.table(miceadds::load.Rdata2("CHIRPS.RData",path=LargeDir))

```

#### Set analytical parameters
The `M.ORIGIN` parameter is a date of origin. It is used to assign other dates an integer number which is the number of days from the date of origin.

```{r CS set parameters, eval=F,echo=T}
# Set date origin for daycount field
M.ORIGIN<-"1900-01-01"

# Set number of cores for parallel processing
cores<-max(1, parallel::detectCores() - 1)

# Name of field that assigns sites a unique ID (in ERA this is a concatenation of Latitude, Longitude and Buffer)
ID<-"Site.Key"

```
#### Prepare ERA dataset
Create a season code field and convert M.Year blanks to `NA` values:

```{r CS prepare ERA 1, eval=F,echo=T}
ERA[Season.Start==1 & Season.End==1,Season:="1"
           ][Season.Start==2 & Season.End==2,Season:="2"
             ][Season.Start==1 & Season.End==2,Season:="1&2"
               ][M.Year=="",M.Year:=NA
                 ][Season=="",Season:=NA]
```

Ensure date fields are class `Date`:
```{r, CS ensure date class, eval=F,echo=T}
ERA[,Harvest.Start:=as.Date(Harvest.Start,"%d.%m.%Y")
    ][,Harvest.End:=as.Date(Harvest.End,"%d.%m.%Y")
      ][,Plant.Start:=as.Date(Plant.Start,"%d.%m.%Y")
        ][,Plant.End:=as.Date(Plant.End,"%d.%m.%Y")]
```

Update missing altitude values with those derived from digital elevation models (DEMs): 

```{r CS add altitude, eval=F,echo=T}
Physical<-data.table(ERA_Physical)

# Add DEM altitude to ERA
ERA[!is.na(Latitude),Altitude.DEM:=Physical[match(unlist(ERA[!is.na(Latitude),..ID]),unlist(Physical[,..ID])) , Altitude.mean]]

# Replace missing altitude values with DEM values
ERA[,Altitude:=Elevation
           ][is.na(Altitude)|Altitude=="",Altitude:=Altitude.DEM]
```

Ensure ERA code fields are data.table format:

```{r CS code tables, echo=T, eval=F}
# Ensure code tables are data.table format
PracticeCodes<-data.table(PracticeCodes)
OutcomeCodes<-data.table(OutcomeCodes)
EUCodes<-data.table(EUCodes)
```

Nest we subset ERA data for 1) crop yields; 2) single season annual products; 3) observations with no temporal aggregation; 4) outcomes that correspond to a single product; and 5) locations with radius of spatial uncertainty less than 25km.

```{r CS subset yields, echo=T, eval=F}

Exclude.Product.Subtypes<-c("Fibre & Wood","Tree","Fodders","Nuts")

Exclude.Products<-c("Sugar Cane (Cane)", "Sugar Cane (Sugar)", "Coffee", "Gum arabic", "Cassava or Yuca", "Pepper", "Vanilla", "Tea", "Plantains and Cooking Bananas", "Jatropha (oil)", "Palm Oil", "Olives (fruits)" , "Olives (oil)", "Taro or Cocoyam or Arrowroot", "Palm Fruits (Other)", "Turmeric", "Ginger", "Cardamom", "Apples", "Oranges", "Grapes (Wine)", "Peaches and Nectarines", "Jujube", "Jatropha (seed)", "Vegetables (Other)", "Herbs", "Pulses (Other)", "Beans (Other)", "Leafy Greens (Other)", "Bananas (Ripe Sweet)", "Jatropha") 

ERA.Yields<-ERA[Out.SubInd == "Crop Yield" & # Subset to crop yields
                  (M.Year.Start == M.Year.End & (Season %in% c(1,2)|is.na(Season))) & # No temporal aggregation
                  !Product.Subtype %in% Exclude.Product.Subtypes &  # Subset to single season annual products
                  !Product %in%  Exclude.Products & # Subset to single season annual products
                  !grepl(" x |-",Product) & # Single products only
                  Buffer<=25000]
```
#### Add Ecocrop data to ERA
When harvest dates are not reported in the studies that comprise ERA we can substitute season length values from the EcoCrop dataset. First we need to merge EcoCrop data with `ERAg::AddEcoCrop` function.

```{r CS add EcoCrop, echo=T, eval=F}
ERA.Yields<-cbind(ERA.Yields,ERAg::AddEcoCrop(Products = ERA.Yields[,Product]))
```

### Prepare Climate dataset
Here we:  
1) replace the rainfall data in the POWER agroclimatology data with the superior data provided by CHIRPS  
2) calculate Penman-Montieth reference evapotranspiration (ETo) in case this has not already been derived  
3) ensure fields are correct classes.  

Note that you can also download this dataset pre-prepared as `POWER.CHIRPS.RData` using the piggyback method.  

```{r CS prepare climate dataset,echo=T,eval=F}

  # Harmonize field names between datasets
  colnames(CHIRPS)[which(colnames(CHIRPS)=="RAIN")]<-"Rain"
  colnames(POWER)[which(colnames(POWER)=="SRad")]<-"Solar.Rad"
  
  # Add altitude to POWER  
  POWER[,Altitude:=Physical[match(as.factor(unlist(POWER[,..ID])),as.factor(unlist(Physical[,..ID]))),Altitude.mean]]
  
  # Remove observations without Altitude and remove the Rain column which will be replaced by CHIRPS data
  POWER<-POWER[!is.na(Altitude)][,Rain:=NULL]
  
  # We will use the dplyr::left_join function to merge the dataset so we convert from data.table to data.frame
  CHIRPS<-as.data.frame(CHIRPS)
  POWER<-as.data.frame(POWER)

  # Combine datasets and convert back to data.table
  POWER.CHIRPS<-data.table(dplyr::left_join(POWER,CHIRPS[,c("DayCount",ID,"Rain")],by = c(ID,"DayCount")))
  
  # Calculate ETo if absent
  if(POWER.CHIRPS[,is.null(ETo)]){
  POWER.CHIRPS[,ETo<-PETcalc(Tmin=Temp.Min,
                            Tmax=Temp.Max,
                            SRad=Solar.Rad ,
                            Wind=WindSpeed,
                            Rain=Rain,
                            Pressure=Pressure,
                            Humid=Humid,
                            YearDay=Day,
                            Latitude=Latitude,
                            Altitude=Altitude)[,1]
  }
  
  # Ensure fields are correct classes
  POWER.CHIRPS[,Site.Key :=as.factor(Site.Key )
               ][,Year:=as.factor(Year)
                 ][,Day:=as.factor(Day)
                   ][,Altitude:=as.integer(Altitude)]
```

### Estimate unreported plantings dates
We may wish to substitute NA values of planting date in ERA with estimates derived from the `EstPDayData` function which searches for planting dates for the same `Product/Product.Subtype`, year and growing season which are spatially nearby.  

The function searches iteratively within five levels of increasing distance corresponding to latitude and longitude recorded from 5 to 1 decimal places. If there is more than one planting date value for a `Product x M.Year.Start x M.Year.End x Season.Start x Season.End` combination then values are averaged. If no corresponding planting dates are found matching on product then matching is attempted on `Product.Subtype` (e.g. cereals or legumes).  

If Latitude + Longitude combinations have a mixture of season = 1 or 2 and season = NA values then this suggests a potential issue with the consistency of temporal recording at the spatial coordinates. Observations with such issues are excluded from the `EstPDayData` analysis and flagged in an output `[[Season.Issues]]` list object.

```{r CS EstPDayData,echo=T,eval=F}
ERA.Yields<-EstPDayData(DATA=ERA.Yields)$DATA

# Estimate % of missing data that could be substituted using EstPDayData estimates
round(sum(!is.na(ERA.Yields$Data.PS.Date))/sum(is.na(ERA.Yields$Plant.Start))*100,2)

```

### Estimate season lengths where harvest dates are missing
Using similar methods to the `EstPDayData` function, the `EstSLenData` estimates season length values from similar crops and locations nearby to missing values.

```{r CS EstSLenData,echo=T,eval=F}
ERA.Yields<-EstSLenData(DATA=ERA.Yields)

# Estimate % of missing data that could be substituted using EstSLenData estimates
round(sum(!is.na(ERA.Yields$SLen))/sum(is.na(ERA.Yields$Data.SLen))*100,2)

```

### Refine Ecocrop cycle lengths
EcoCrop data for crop cycle length estimates (how long a crop takes to grow) can have a large range, especially for crops that can be grown in temperate and tropical regions. Maize, for example, as a season length of 65-365 days with midpoint 215 days, this is a rather unrealistically long season for most of sub-Saharan Africa. We can mine ERA data where we have crop planting and harvest dates of reasonably certainty to esimate season length and replace EcoCrop estimates.

```{r ,echo=T,eval=F}
  # Estimate season length from date allowing 7 days uncertainty in planting and harvest dates
  A<-ERA.Yields
  A<-unique(A[!(is.na(Plant.Start)|is.na(Plant.End)|is.na(Harvest.End)|is.na(Harvest.End))
              ][,PLANT.AVG:=Plant.Start+(Plant.End-Plant.Start)/2
                ][,HARVEST.AVG:=Harvest.Start+(Harvest.End-Harvest.Start)/2
                  ][!(((Plant.End-Plant.Start)>7)|((Harvest.End-Harvest.Start)>7))
                    ][,SLEN:=round(HARVEST.AVG-PLANT.AVG,0)
                      ][!SLEN<30,c("Product",..ID,"Code","Variety","M.Year","PLANT.AVG","SLEN","Country")])
  
  B<-A[,list(SLEN.mean=mean(SLEN),SLEN.med=median(SLEN),N=.N),by=c("Product")
       ][,SLEN.mean:=round(as.numeric(SLEN.mean),0)
         ][,SLEN.med:=round(as.numeric(SLEN.med),0)]
  
  B[,SLEN.EcoC:=round(apply(ERA.Yields[match(B$Product,ERA.Yields$Product),c("cycle_min","cycle_max")],1,mean),0)]
  
  # Replace EcoCrop values where we have >=5 observation from our data
  B<-B[N>=5]
  
  # Save estimate crop length datasets
  fwrite(B,paste0(CROP_dir,"Crop Season Lengths Estimated From Data.csv"))
  
  # Add estimate season lengths to ERA where season length values are missing
  N<-match(ERA.Yields$Product,B$Product)
  N1<-which(!is.na(N))
  ERA.Yields$cycle_min[N1]<-B$SLEN.med[N[N1]]
  ERA.Yields$cycle_max[N1]<-B$SLEN.med[N[N1]]

```

### Refine uncertain planting dates using rainfall data
It is not uncommon for studies in ERA to report vague dates such as "May-June" creating uncertainty around the start of the growing season. Where there is a large difference between `Plant.Start` and `Plant.End` we can use the `EstPDayRain` function to estimate more precise planting dates using rainfall data.  

Planting dates are estimated for rows in `ERA.Yield` where the difference between `Plant.Start` and `Plant.End` is greater than or equal to the `Uncertainty.Min` argument and less than or equal to the `Uncertainty.Max` argument.  

`EstPDayRain` uses the rollapply function to sum rainfall within a scanning window, planting is assumed to occur the day after summed rainfall surpasses a threshold amount.  

For each row of `ERA.Yield` with appropriate planting uncertainty the function initially searches for rainfall events in `CHIRPS` in-between and including the corresponding `Plant.Start` and `Plant.End` dates. This temporal search period can be modified using the `DaysBefore` and `MultiplyWin` arguments. `DaysBefore` extends the `Plant.Start` date backwards by a number of days. `MultiplyWin` is a proportion that multiplies the difference between `Plant.Start` and `Plant.End` dates increasing the size of the period forwards in time. If `Plant.Start = 2018-01-01` and `Plant.End = 2018-01-11` the difference between them is 10 days, if `MultiplyWin = 1.5` then `10*1.5=15` and the end of the initial search window becomes `2018-01-01 + 15 = 2018-01-16`. The width (in days) of the rollapply scanning window is specified by the `Width` argument and the amount of rainfall (mm) required to trigger planting within the scanning window is specified by the `Rain.Thresholds` argument.  

Up to two additional temporal search periods after the above can be specified in days using the `Window` arguments, for each extra window added the `Width` and `Rain.Thresholds` arguments require corresponding values to added in sequence. If no trigger events are found in the initial scanning window then subsequent windows are searched in order.

By setting the `Use.Data.Dates` argument to `TRUE` we are substituting `NA` planting dates in ERA with values calculated by `EstPDayData` and refining these with the `EstPDayRain` function.

```{r CS EstPDayRain 2, echo=T, eval=F}
ERA.Yields<-EstPDayRain(Data=ERA.Yields, 
                    ID=ID, 
                    Rain.Data = CHIRPS, # You could also use POWER.CHIRPS here
                    Rain.Data.Name = "CHIRPS", 
                    Rain.Field ="Rain", 
                    # DaysBefore: When searching for rainfall events in-between the uncertain planting start/end dates
                    # supplied in ERA.Yieds extend the planting start date backwards by 2 days
                    DaysBefore = 2,
                    #  MultiplyWin: a proportion that changes the size of the difference between plant start and plant 
                    # end, 1 = no change
                    MultiplyWin = 1, 
                    # Window: add two addition temporal periods beyond the initial temporal window of 14 days
                    Window = c(14,14), 
                    # Widths: We need to set a threshold for the rainfall amount in mm that triggers planting within each 
                    # window in this case there are 3 windows 1 + the 2 extra windows specified in the `Window` argument
                    Widths = c(2,3,3), 
                    # Rain.Thresholds: We need to set a threshold for the rainfall amount in mm that triggers planting in each 
                    # window if `Widths[1]=2` and `Rain.Thresholds[1]=30` then 30mm needs to fall over 2 days within the initial
                    # window of plant start to plant end dates (as modified by DaysBefore and  MultiplyWin arguments) for 
                    # planting to occur. If the threshold is not met then function iteratively goes to `Window[1]`, `Widths[2]` and 
                    # `Rain.Thresholds[2]`.
                    Rain.Thresholds = c(30,20,15), 
                    # Uncertainty.Min/Uncertainty.Max: refine planting dates with uncertainty of between 7-90 days
                    Uncertainty.Min = 7, 
                    Uncertainty.Max = 90, 
                    Add.Values = T, 
                    Use.Data.Dates = T  
                    )


```

### Calculate Climate Variables
We use the `CalcClimate` function to apply a complex sequence of calculations to the `ERA.Yield` and `POwER.CHIRPS` data.tables. `CalcClimate` calculates seasonal and long-term average climate variables the deviance of the seasonal values from  long-term averages. `CalcClimate` can also provide bioclimatic variables annually with long-term averages and annual deviances (argument `Do.BioClim=T`).   

The `Observed` data.table returned in the output list shows calculates climate variables (such as growing degree days, total rainfall and dry-spells) using the ERA dataset provided and temporal windows of calculation defined using the `Win.Start` and `Windows` arguments. Two calculations windows are defined by default: `Data` which uses the planting and harvest dates reported/estimated and `EcoCrop` which uses the planting dates reported/estimated and EcoCrop estimates of season length. Additional windows of analysis (e.g. post planting 1-30 days after planting) can are defined using the `Windows` argument.  

If argument `Do.LT.Avg=T`estimates of long-term climate are estimated using planting dates derived from the rainfall data supplied (and not the ERA data, unlessinsufficient rainfall to estimate a planting date) and the arguments `Rain.Windows`, `Widths`, `Rain.Threshold` and `LongTerm`. The end years of the period for which long-term averages are calculated is set using the `Max.LT.Avg` argument.  

`ClacClimate` Process:  

1. Season Length `SLen` is calculated as difference between mean planting and harvest dates.  

2. The `SLen` function is applied to the data which combines accurate temporal planting/harvest data with estimates using the following and sequential logic:
    a. where `(Plant.End-Plant.Start)>20`and a planting date derived from the `EstPDayRain` function is available `SLen` is substituted for `Harvest.End` - rainfall estimate planting date;
    b. where `(Plant.End-Plant.Start<20) & (Harvest.End-Harvest.Start>=20)` `SLen` is substituted for `Harvest.End-(Plant.Start+(Plant.End-Plant.Start)/2)`;
    c. A `P.Date.Merge` field is added to `DATA` as `Plant.Start+(Plant.End-Plant.Start)/2`;
    d. Missing `NA` values of `P.Date.Merge` are substituted with estimates derived from similar nearby observations estimated using the `EstPDayData` function;
    e. A `SLen.Merge`  field is added to `DATA` equivalent to the `SLen` field with missing `NA` values substituted with estimates derived from similar nearby observations estimated using the `EstSLenData` function;
    f. A `SLen.Ecocrop` field is added to `DATA` as `(cycle_min+cycle_max)/2`;
    g. `DATA` is subset to data.table named `SS` which contains unique values of location, product, observation date and planting/harvest/season length fields. Some form of planting date and season length estimate must be present;
    h. Where there is a difference of greater than 60% between ecocrop vs data estimates of season length observations are rejected.

*The use of Harvest.End in Steps 2a & 2b is deliberate; when uncertainty is large using mean planting and harvest dates can result in unrealistically short season lengths that distort measures of seasonal climate, especially precipitation. The use of Harvest.End may overestimate season length overall for highly uncertain scenarios, but we consider the effect this on seasonal climate measures less severe.*

3. For each row of `SS` the `CLIMATE` dataset is filtered on the `Date` field for two temporal periods based on the date fields `P.Date.Merge` and `SLen.Merge` or `SLen.Ecocrop`, note one day is added to `P.Date.Merge` so the temporal window begins the day after planting. An additional temporal windows can be specified using data.table supplied to the `Windows` argument, the data.table requires three fields: 1) `Name`; 2) `Start` and 3) `End`. The `Start` and `End` fields define the additional temporal period as days after`P.Date.Merge`.For example `Window=data.table(Name="Plant.1-30",Start=1,End=30)` is a temporal period from planting to 30 days after planting.

4. For each temporal period specified in 3) climate statistics are calculated:
    a.  *growing degrees days (GDD)* are calculated using the `GDDcalc` function which requires daily `Tmax` and `Tmin` fields from `CLIMATE` and the EcoCrop optimal and absolute temperate thresholds (fields `Tlow`, `Topt.low`, `Topt.high`, and `Thigh`) added to `DATA` using the `AddEcoCrop` function. The `GDDcalc` function outputs four fields `GDDlow`, `GDDopt`, `GDDhigh` and `GDDmax` and the values of these are summed for the temporal period;
    b. *precipitation and reference evapotranspiration (ETo)* statistics are estimated using the `RAIN.Calc` function which outputs a number of variables described in the documentation for this function;
    c. *max and mean temperatures* are averaged with standard deviation (`Tmax.Mean`,`Tmax.sd`,`Tmean.mean` and `Tmean.sd` fields).

5. If argument `Do.LT.Avg==T` annual and long-term climate statistics an planting dates are calculated  for each combination of location and product. Note that each season in the data is treated separately. The process logic is as follows:
    a. The median planting julian day of the year is taken for the location x product combination;
    b. For each year of complete climate data, the median planting date from 5a is used as a starting point to estimate planting date from rainfall using the `Est.Rain` function which takes the arguments `Rain.Windows`, `Widths` and `Rain.Threshold` as explained in the arguments for this function. These data are returned as `[[LongTerm]][[LT.PD.Years]]`; 
    c. Estimated planting dates from 5b are averaged (mean, sd, median) across years and returned as `[[LongTerm]][[LT.PD.Avg]]`;
    d. Annual planting date deviance is calculated as the absolute difference between the annual and mean/median planting dates and appended to the output of 5b;
    e. Annual climate statistics are calculated for each year x site x product combination using the rainfall estimated planting date and as per steps 3 & 4. Data are return as `[[LongTerm]][[LT.Clim.Years]]`. Where insufficient rainfall fell to meet the thresholds specified in 5b then the a median planting date is substituted from those years that did have sufficient rainfall in 5b;
    f. Long-term climate statistics from 5e are calculated across years for mean, median, standard deviation, minimum and maximum statistics. Data are returned `[[LongTerm]][[LT.Clim.Avg]]`;
    g. Deviance from long-term mean and median values for each climate statistic is appended as columns to the output of 5e.

6. If argument `Do.BioClim==T` then:
    a. Annual bioclimatic values are calculated using the [`dismo::biovars`](https://rdrr.io/cran/dismo/man/biovars.html) function for each complete year of data in `CLIMATE` per unique locationas (`ID` field) in `DATA`. The output data is return as [[Annual.BioClim]][[Annual.Estimates]]`;
    b. Bioclim variables are averaged over time to give long-term mean and median values. The output data is return as [[Annual.BioClim]][[LT.Averages]]`; 
    c. Deviance from long-term mean and median values for each climate statistic is appended as columns to the output of i).

If you are finding there are observations with suspiciously short reported season lengths in the ERA dataset (i.e. errors in the reporting of planting and/or harvest dates) you can exclude observations (`Exclude.EC.Diff`) where the absolute difference between reported and EcoCrop estimated season lengths is greater than a specified proportion (`EC.Diff`).

```{r CS CalcClimate, echo=T, eval=F}
Climate<-CalcClimate(DATA=ERA.Yields,
                ID=ID,
                CLIMATE=POWER.CHIRPS,
                Rain.Data.Name="CHIRPS", 
                Temp.Data.Name="POWER",
                # Rain.Windows: In estimation of planting dates for long-term climate calculation we will look for
                # rainfall events in 4 windows: 6 weeks before planting (the first element supplied is always before
                # planting set to 0 if you do not want to look before planting), then in three consecutive windows
                # of 4, 2 and 2 weeks
                Rain.Windows = c(6*7,4*7,2*7,2*7),  
                # Widths: To estimate planting dates rainfall is summed in a scanning window for each of the windows 
                # specified in Rain.Windows; we have 4 windows so need to supply 4 values in days to this argument
                Widths = c(3,3,2,2),  
                # Rain.Threshold: We need to set a threshold for the rainfall amount in mm that triggers planting in 
                # each combination of `Rain.Window` x `Width`, again 4 values. If Rain.Window = 4*7 & Width = 3 and 
                # Rain.Threshold = 30 then the function looks within a 21 window for cumulative rainfall of 30mm over 
                # 3 days
                Rain.Threshold = c(30,30,20,15), 
                # Win.Start: When calculating climate from planting.dates and harvest.dates Win.Start adjust the 
                # beginning date of the calculation window. -3 means the window begins 3 days before planting
                Win.Start=-3,
                # Max.LT.Avg: Calculations of long-term climate only use years up to and including 2010
                Max.LT.Avg=2010, 
                Do.LT.Avg=T, 
                Do.BioClim=T, 
                # Windows: By default this function looks at two calculation windows `Data` and `EcoCrop`. Additional 
                # windows can specified the `Windows` argument. In the line below the additional window will called 
                # `Plant.1-30` in the `W.Name` field of output data.tables and it begins 1 day after planting and ends 
                # 30 days after planting. This window explores the post-planting climate, a critical period for crop 
                # establishment and success
                Windows=data.table(Name="Plant.1-30",Start=1,End=30), 
                SaveDir=AnalysisDir,
                ErrorDir=NA,
                ROUND=3)    
```

```{r CS add climate data, echo=F, eval=T}
Climate<-ERAg::Climate.Vignette
```

#### What is output by the `CalcClimate` function?

##### Output [["Paramters"]]

First you can recall the parameters used in the analysis by accessing the `Parameters` list

```{r CS Params Output, echo=T,eval=T}
Climate[["Parameters"]]
```

##### Output [["Observed"]]

The primary data output is the `Observed` data.table (created in process step 4). 

```{r CS Observed Output, echo=T,eval=T}
Climate[["Observed"]][1:3,]
```
This data table provides a number of fields summarizing growing season climate:

1. Growing degree days:
+ `GDDlow` growing degree hours below optimal EcoCrop temperature threshold (h)
+ `GDDopt` growing degree hours within optimal EcoCrop temperature thresholds (h)
+ *`GDDhigh` growing degree hours above optimum and below maximum EcoCrop temperature thresholds (h)
+ `GDDmax` growing degree hours above EcoCrop maximum temperature threshold (h)

  *`GDDhigh` and `GDDmax` tell us something about crop exposure to thermal stresses.*

2. Dry spells:
+ `Rain.Days.L.0` total number of days with 0 mm rainfall (days)
+ `Rain.Days.L.1` total number of days with less than 1 mm rainfall (days)
+ `Rain.Days.L.5` total number of days with less than 5 mm rainfall (days)
+ `Rain.Max.RSeq.0` longest continuous period of days with 0 mm rainfall (days)
+ `Rain.Max.RSeq.0.1` longest continuous period of days with less than 0.1 mm rainfall (days)
+ `Rain.Max.RSeq.1` longest continuous period of days with less than 1 mm rainfall (days)
+ `Rain.Max.RSeq.5` longest continuous period of days with less than 5 mm rainfall (days)
+ `Rain.N.RSeq.T0.D7` number of continuous periods of 7 days or more of 0 mm rainfall
+ `Rain.N.RSeq.T1.D7` number of continuous periods of 7 days or more of less than 1 mm rainfall
+ `Rain.N.RSeq.T5.D7` number of continuous periods of 7 days or more of less than 5 mm rainfall
+ `Rain.N.RSeq.T0.D14` number of continuous periods of 14 days or more of 0 mm rainfall
+ `Rain.N.RSeq.T1.D14` number of continuous periods of 14 days or more of less than 1 mm rainfall
+ `Rain.N.RSeq.T5.D14` number of continuous periods of 14 days or more of less than 5 mm rainfall
+ `Rain.N.RSeq.T0.D21` number of continuous periods of 21 days or more of 0 mm rainfall
+ `Rain.N.RSeq.T1.D21` number of continuous periods of 21 days or more of less than 1 mm rainfall
+ `Rain.N.RSeq.T5.D21` number of continuous periods of 21 days or more of less than 5 mm rainfall

3. Rainfall, reference evapotranspiration and their difference:
+ `Rain.sum` total rainfall (mm)
+ `ETo.sum` summed Penman-Monteith reference evapotranspiration (mm)
+ `ETo.NA` number of NA values in Penman-Monteith reference evapotranspiration
+ `WBalance` as `Rain.sum-ETo.sum` the difference between rainfall and reference evapotranspiration (mm)

4. Average daily mean & max temperatures:
+ `Tmax.mean` mean of daily maximum temperatures (C)
+ `Tmax.sd` standard deviation of daily maximum temperatures (C)
+ `Tmean.mean` mean of daily mean temperatures (C)
+ `Tmean.sd` standard deviation of daily mean temperatures (C)

5. Metadata fields:
+ `EU` ERA experimental unit (or product) code see `ERAg::EUCodes` for translations
+ `PD.Used` planting date used in calculations
+ `W.Start` adjust of the start date of the climate calculation window as days before (negative) or after (positive) after planting date (days)
+ `W.End` end point of the climate calculation window as the number of days after `PD.Used + W.Start` (days)
+ `W.Name` name of the climate window being considered. `Data` planting and harvest dates reported in publications used to define the climate calculation window. `EcoCrop` EcoCrop database used to define season lengths (i.e. `W.End`) for the climate calculation window, unless sufficient data existed within ERA to estimate season length for the specific crop.
+ `ID` unique ID for site provided to the `CalcClimate` function (for `ERA.Compiled` this is usually `Site.Key`)
+ `M.Year` measurement year, this should correspond the to year at the end of the climate calculation window (y)
+ `Season` measurement season (1, 2 or NA)

##### Output [["LongTerm"]]

If argument `Do.LT.Avg=T` then a list level named `LongTerm` is output containing four data.tables.

1. **Annual Planting dates `[["LongTerm"]][["LT.PD.Years"]]`**  

Planting dates estimated from rainfall data as per processes 5a, 5b and 5d. 

```{r CS Observed PD Years, echo=T,eval=T}
Climate[["LongTerm"]][["LT.PD.Years"]][1:3,]
```

The above data.table contains annual estimates of planting dates.

    1.1. Rainfall estimated dates:
    +  `P.Year` planting year of crop (y)
    +  `P.Date` planting date of crop; class `Date` with format `%Y%m%d`
    +  `P.Data.Flag` indicates if no seasons in a time-series met the rainfall thresholds required for planting. If this occurs then the  mid-point of the reported planting dates is used for `P.Year` and `P.Date` fields.

    1.2. Deviance from long-term averages:
    +  `Dev.Mean` deviance in days of planting date from **mean** long-term  planting date calculated for location (d)
    +  `Dev.Med` deviance in days of planting date from **median** long-term planting date calculated for location (d)

    1.3 Metadata fields:
    +  `EU` ERA experimental unit (product) code see `ERAg::EUCodes` for translations
    +  `Season` growing season of year for bimodal areas
    +  `ID` unique ID for site provided to the `CalcClimate` function (for `ERA.Compiled` this is usually `Site.Key`)

2. **Long-term Average Planting dates `[["LongTerm"]][["LT.PD.Avg"]]`**  
Long-term mean and median estimates of julian planting day across time as per process 5c.

```{r CS LTAvg PD Years, echo=T,eval=T}
Climate[["LongTerm"]][["LT.PD.Avg"]][1:3,]
```

Fields are the same as `Climate[["LongTerm"]][["LT.PD.Years"]]` apart from:

    + Mean mean planting date in julian days (d)
    + Median median planting date in julian days (d)
    + SD standard deviation of mean planting date (d)
    + N number of years used to calculate long-term average

3. **Annual climate statistics `[["LongTerm"]][["LT.Clim.Years"]]`**:
Climate statistics calculated using rainfall estimates planting dates as per processes 5e & 5g.


```{r CS LT.Clim.Years, echo=T,eval=T}
Climate[["LongTerm"]][["LT.Clim.Years"]][1:3,]
```

Fields are the same as the `Observed` table apart from:

    + `P.Year` year of planting (y)
    + `H.Year` year of harvest (or end of calculation window) (y)
    + `Variable` in rows where this field is `Annual.Value` statistics are calculated for the year in question, whereas statistics in `Dev.Mean` and `Dev.Med` rows show annual deviance from long-term averages (`[["LongTerm"]][["LT.Clim.Avg"]]`).

```{r CS LT.Clim.Years Variables, echo=T,eval=F}
Climate[["LongTerm"]][["LT.Clim.Years"]][,unique(Variable)]
```
```{r Bug hack, echo=F,eval=T}
c("Dev.Mean","Dev.Med","Annual Value")
```

4. **Long-term climate statistics `[["LongTerm"]][["LT.Clim.Avg"]]`**:
Long-term mean and median estimates of planting statistics across time as per process 5f.

```{r CS LT.Clim.Avg, echo=T,eval=T}
Climate[["LongTerm"]][["LT.Clim.Avg"]][1:3,]
```
The `Variable` field values in this table indicates are `Mean`, `Median`, `SD`, `Min` and `Max` indicating the function applied to each climate statistic across the temporal period for each location x crop x season.

##### Output [["BioClim"]]
If argument `Do.BioClim=T` then a list level named `BioClim` is output containing two data.tables.

1. **Annual bioclimatic variables `[["BioClim"]][["Annual.Estimates"]]`**  

Annual estimates of bioclimatic variables for each location as per processes 6a & 6c.

```{r CS BioClim Years, echo=T,eval=T}
Climate[["BioClim"]][["Annual.Estimates"]][1:3,]
```

For an explanation of the `BIO` codes see `ERAg::BioClimCodes`:

```{r CS BioClim Codes, echo=T,eval=T}
  ERAg::BioClimCodes
```
Values in the `Variable` field indicate:

    + `Annual.Value` statistics are calculated for the year in question
    + `Dev.Mean` annual deviance from long-term mean
    + `Dev.Median` annual deviance from long-term median

2. **Long-term bioclimatic variables `[["BioClim"]][["LT.Averages"]]`**  

Long-term averages of bioclimatic variables derived from `[["BioClim"]][["Annual.Estimates"]]` as per process 6b.

```{r CS BioClim LTAvg, echo=T,eval=T}
Climate[["BioClim"]][["LT.Averages"]][1:3,]
```
Values in the `Variable` field indicate whether the mean, median or standard deviation of each `BIO` field is taken.  
The `N` field indicates the number of observations (years/seasons) in the time-series.

```{r CS BioClim LTAvg Vars, echo=T,eval=F}
Climate[["BioClim"]][["LT.Averages"]][,unique(Variable)]
```
```{r bug hack 2,echo=F,eval=T}
c("Mean","Median","SD")
```
